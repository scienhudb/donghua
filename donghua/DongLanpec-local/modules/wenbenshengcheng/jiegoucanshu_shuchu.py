import os
import pymysql
from openpyxl import load_workbook


from modules.chanpinguanli.chanpinguanli_main import product_manager

product_id = None


def on_product_id_changed(new_id):
    print(f"Received new PRODUCT_ID: {new_id}")
    global product_id
    product_id = new_id


# 测试用产品 ID（真实情况中由外部输入）
product_manager.product_id_changed.connect(on_product_id_changed)

SHEET_RULES = {
    "管箱封头": {
        "mapping": {
            5: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱封头", "Name": "封头类型代号"},
            7: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱封头", "Name": "封头公称直径"},
            8: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱封头", "Name": "是否以外径为基准"},
            9: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱封头", "Name": "椭圆形封头名义厚度"},
            10: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱封头", "Name": "椭圆形封头直边高度"},
            11: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱封头", "Name": "椭圆形封头名义厚度"},
            12: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱封头", "Name": "椭圆形封头有效厚度"},
        },
        "fixed": {6: "GB/T 25198-2023"},
        "aiming1": {"D": "Id", "F": "Value"},
    },

    "管箱圆筒": {
        "mapping": {
            6: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱圆筒", "Name": "圆筒公称直径"},
            7: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱圆筒", "Name": "是否按外径计算"},
            8: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱圆筒", "Name": "圆筒名义厚度"},
            9: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱圆筒", "Name": "圆筒名义厚度"},  # 重复写
            10: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱圆筒", "Name": "圆筒长度"},
        },
        "fixed": {5: "GB/T 25198-2023"},
        "aiming1": {"D": "Id", "F": "Value"},
    },

    "管箱法兰": {
        "mapping": {
            8: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱法兰", "Name": "法兰名义厚度"},
            9: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱法兰", "Name": "法兰名义内径"},
            10: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱法兰", "Name": "法兰名义外径"},
            11: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱法兰", "Name": "法兰颈部高度"},
            12: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱法兰", "Name": "法兰总高"},
            13: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱法兰",
                 "Name": "法兰颈部大端名义厚度"},
            14: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱法兰",
                 "Name": "法兰颈部小端名义厚度"},
            15: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱法兰", "Name": "螺栓中心圆直径"},
            5: {"table": "产品设计活动表_元件附加参数表", "元件名称": "管箱法兰", "参数名称": "法兰类型"},
            6: {"table": "产品设计活动表_元件附加参数表", "元件名称": "管箱法兰", "参数名称": "法兰密封面"},
        },
        "fixed": {19: 6, 20: 6},
        "aiming1": {"D": "Id", "F": "Value"},
        "aiming2": {"F": "参数值"}
    },
"壳体封头": {
        "mapping": {
            5: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体封头", "Name": "封头类型代号"},
            7: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体封头", "Name": "封头公称直径"},
            8: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体封头", "Name": "是否以外径为基准"},
            9: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体封头", "Name": "椭圆形封头名义厚度"},
            10: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体封头", "Name": "椭圆形封头直边高度"},
            11: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体封头", "Name": "椭圆形封头名义厚度"},
            12: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体封头", "Name": "椭圆形封头有效厚度"},
        },
        "fixed": {6: "GB/T 25198-2023"},
        "aiming1": {"D": "Id", "F": "Value"},
    },

    "壳体圆筒": {
        "mapping": {
            6: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体圆筒", "Name": "圆筒公称直径"},
            7: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体圆筒", "Name": "是否按外径计算"},
            8: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体圆筒", "Name": "圆筒名义厚度"},
            9: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体圆筒", "Name": "圆筒名义厚度"},  # 重复写
            10: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体圆筒", "Name": "圆筒长度"},
        },
        "fixed": {5: "GB/T 25198-2023"},
        "aiming1": {"D": "Id", "F": "Value"},
    },

    "壳体法兰": {
        "mapping": {
            8: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体法兰", "Name": "法兰名义厚度"},
            9: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体法兰", "Name": "法兰名义内径"},
            10: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体法兰", "Name": "法兰名义外径"},
            11: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体法兰", "Name": "法兰颈部高度"},
            12: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体法兰", "Name": "法兰总高"},
            13: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体法兰",
                 "Name": "法兰颈部大端名义厚度"},
            14: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体法兰",
                 "Name": "法兰颈部小端名义厚度"},
            15: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体法兰", "Name": "螺栓中心圆直径"},
            5: {"table": "产品设计活动表_元件附加参数表", "元件名称": "壳体法兰", "参数名称": "法兰类型"},
            6: {"table": "产品设计活动表_元件附加参数表", "元件名称": "壳体法兰", "参数名称": "法兰密封面"},
        },
        "fixed": {19: 6, 20: 6},
        "aiming1": {"D": "Id", "F": "Value"},
        "aiming2": {"F": "参数值"}
    },
    "接管法兰": {
        "mapping": {
            8: {"table": "产品设计活动表_元件计算结果表", "元件名称": "接管法兰", "Name": "接管法兰名义厚度"},
            9: {"table": "产品设计活动表_元件计算结果表", "元件名称": "接管法兰", "Name": "接管法兰名义内径"},
            10: {"table": "产品设计活动表_元件计算结果表", "元件名称": "接管法兰", "Name": "接管法兰名义外径"},
            11: {"table": "产品设计活动表_元件计算结果表", "元件名称": "接管法兰", "Name": "颈部高度"},
            12: {"table": "产品设计活动表_元件计算结果表", "元件名称": "接管法兰", "Name": "法兰总高"},
            13: {"table": "产品设计活动表_元件计算结果表", "元件名称": "接管法兰", "Name": "颈部大端名义厚度"},
            14: {"table": "产品设计活动表_元件计算结果表", "元件名称": "接管法兰", "Name": "颈部小端名义厚度"},
            15: {"table": "产品设计活动表_元件计算结果表", "元件名称": "接管法兰", "Name": "螺栓中心圆直径"},
            5: {"table": "产品设计活动表_元件附加参数表", "元件名称": "接管法兰", "参数名称": "法兰类型"},
            6: {"table": "产品设计活动表_元件附加参数表", "元件名称": "接管法兰", "参数名称": "法兰密封面"},
        },
        "fixed": {19: 6, 20: 6},
        "aiming1": {"D": "Id", "F": "Value"},
        "aiming2": {"F": "参数值"}
    },

    "分程隔板": {
        "mapping": {
            7: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱分程隔板", "Name": "公称直径"},
            8: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱分程隔板", "Name": "管箱圆筒长度"},
            9: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱分程隔板",
                "Name": "管箱法兰高度（焊端至密封面）"},
            10: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管箱分程隔板",
                 "Name": "管箱分程隔板名义厚度"},
        },
        "fixed": {5: "2", 6: "椭圆封头形", 11: "10", 12: "45", 13: "15"},
        "aiming1": {"D": "Id", "F": "Value"},
    },

    "U形管板": {
        "components": ["固定管板"],  # 明确来源的元件名
        "mapping": {
            5: {"table": "产品设计活动表_元件计算结果表", "元件名称": "固定管板", "Name": "管板名义厚度"},
            6: {"table": "产品设计活动表_元件计算结果表", "元件名称": "固定管板", "Name": "管板外径"},

            "fixed": {7: "6", 8: "2", 9: "12", 10: "12"},

        },
        "aiming1": {"D": "Id", "F": "Value"},

    },
    "管束": {
        "components": ["管束"],  # 明确来源的元件名

        "mapping": {
            5: {"table": "产品设计活动表_布管参数表", "参数名": "壳体内径 Di"},
            6: {"table": "产品设计活动表_布管参数表", "参数名": "换热管外径"},
            7: {"table": "产品设计活动表_布管参数表", "参数名": "换热管壁厚"},
            8: {"table": "产品设计活动表_布管参数表", "参数名": "换热管中心距 S"},
            9: {"table": "产品设计活动表_布管参数表", "参数名": "布管限定圆 DL"},
            10: {"table": "产品设计活动表_布管参数表", "参数名": "分程隔板两侧相邻管中心距Sn（竖直）"},
            11: {"table": "产品设计活动表_布管参数表", "参数名": "分程隔板两侧相邻管中心距Sn（水平）"},
            13: {"table": "产品设计活动表_布管参数表", "参数名": "非布管区域弦高（0°/180°）"},
            14: {"table": "产品设计活动表_布管参数表", "参数名": "非布管区域弦高（0°/180°）"},
            15: {"table": "产品设计活动表_布管参数表", "参数名": "非布管区域弦高（90°/270°）"},
            16: {"table": "产品设计活动表_布管参数表", "参数名": "非布管区域弦高（90°/270°）"},
            18: {"table": "产品设计活动表_布管参数表", "参数名": "隔条位置尺寸 W"},
            20: {"table": "产品设计活动表_布管参数表", "参数名": "换热管排列方式"},
            21: {"table": "产品设计活动表_布管参数表", "参数名": "换热管布置方式"},
            22: {"table": "产品设计活动表_布管参数表", "参数名": "管程程数"},
            27: {"table": "产品设计活动表_元件计算结果表", "元件名称": "固定管板", "Name": "管板名义厚度"},
            28: {"table": "产品设计活动表_布管参数表", "参数名": "换热管公称长度 LN"},
            30: {"table": "产品设计活动表_管板连接表", "参数名": "换热管伸出管板长度 L",
                 "管板连接方式": "强度焊接加贴胀"},
            31: {"table": "产品设计活动表_管板连接表", "参数名": "焊角外伸高度 E",
                 "管板连接方式": "强度焊接加贴胀"},
            32: {"table": "产品设计活动表_管板连接表", "参数名": "换热管伸出管板长度 L",
                 "管板连接方式": "强度焊接加贴胀"},
            33: {"table": "产品设计活动表_管板连接表", "参数名": "管程侧坡口深度 G",
                 "管板连接方式": "强度焊接加贴胀"},
            34: {"table": "产品设计活动表_管板连接表", "参数名": "焊角外伸高度 E",
                 "管板连接方式": "机械强度胀接加密封焊"},
            35: {"table": "产品设计活动表_管板连接表", "参数名": "换热管伸出管板长度 L",
                 "管板连接方式": "机械强度胀接加密封焊"},
            36: {"table": "产品设计活动表_管板连接表", "参数名": "管程侧坡口深度 G",
                 "管板连接方式": "机械强度胀接加密封焊"},
            37: {"table": "产品设计活动表_管板连接表", "参数名": "换热管伸出管板长度 L",
                 "管板连接方式": "强度胀接"},
            38: {"table": "产品设计活动表_管板连接表", "参数名": "管程侧坡口深度 U", "管板连接方式": "强度胀接"},
            39: {"table": "产品设计活动表_管板连接表", "参数名": "强度胀接长度 X", "管板连接方式": "强度胀接"},
            45: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管束", "Name": "折流板/支持板外直径"},
            46: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管束", "Name": "折流板/支持板外直径下偏差"},
            49: {"table": "产品设计活动表_布管参数表", "参数名": "折流/支持板间距"},
            50: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管束",
                 "Name": "折流板厚度"},
            51: {"table": "产品设计活动表_布管参数表", "参数名": "折流板切口与中心线间距"},
            57: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管束",
                 "Name": "固定管板侧内折流板数量"},
            58: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管束",
                 "Name": "第一块内折流板至固定管板间距"},
            59: {"table": "产品设计活动表_布管参数表", "参数名": "折流/支持板间距"},
            62: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管束",
                 "Name": "折流板厚度"},
            63: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管束",
                 "Name": "支持板厚度"},
            64: {"table": "产品设计活动表_布管参数表", "参数名": "折流板切口与中心线间距"},

        },
        "aiming1": {"D": "Id", "F": "Value"},
        "aiming2": {"F": "参数值"},

        "fixed": {47: "0.4", 48: "0.25", 56: "12"},
    },
    "管束附件": {
        "components": ["管束"],  # 明确来源的元件名

        "mapping": {
            8: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管束", "Name": "定距管长度1"},
            9: {"table": "产品设计活动表_元件计算结果表", "元件名称": "管束", "Name": "定距管长度2"}, },
        6: {"table": "产品设计活动表_布管参数表", "参数名": "换热管外径 do"},
        7: {"table": "产品设计活动表_布管参数表", "参数名": "换热管壁厚 δ"},
        12: {"table": "产品设计活动表_布管参数表", "参数名": "拉杆规格"},
        15: {"table": "产品设计活动表_布管参数表", "参数名": "换热管外径 do"},
        16: {"table": "产品设计活动表_布管参数表", "参数名": "换热管壁厚 δ"},
        27: {"table": "产品设计活动表_布管参数表", "参数名": "中间挡板厚度"},
        28: {"table": "产品设计活动表_布管参数表", "参数名": "中间挡板宽度"},
        32: {"table": "产品设计活动表_布管参数表", "参数名": "滑道与竖直中心线夹角"},
        33: {"table": "产品设计活动表_布管参数表", "参数名": "滑道厚度"},
        34: {"table": "产品设计活动表_布管参数表", "参数名": "滑道高度"},

        "fixed": {17: "50", 18: "50", 20: "4", 21: "5", 24: "50", 25: "50", 29: "50", 30: "50", 35: "15", 36: "1",
                  37: "50", 38: "50", },
        "aiming1": {"D": "Id", "F": "Value"},
        "aiming2": {"F": "参数值"},
    },
    "固定鞍座": {
        "fixed": {
            5: "BⅠ",
            6: "固定端",
            7: "右",
            12: "120"
        },
        "mapping": {
            8: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体圆筒", "Name": "圆筒公称直径"},
            9: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体圆筒", "Name": "是否按外径计算"},
            10: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体圆筒", "Name": "圆筒名义厚度"},

            13: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "鞍式支座高度h"},
            14: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "底板长度"},
            15: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "底板宽度"},
            16: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "底板厚度"},
            17: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "腹板厚度"},

            35: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "筋板长度"},
            36: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "筋板宽度"},
            37: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "筋板顶部宽度"},
            38: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "筋板厚度"},
            39: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "垫板厚度"},
            40: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "垫板弧长"},
            41: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "垫板宽度"},
            42: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "腹板至垫板边缘距离"},

            48: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "螺纹规格"},
            49: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "螺孔直径"},
            50: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "螺孔长度"},
            51: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "螺栓孔间距1"},
            52: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "螺栓孔间距2"},
        },
        "aiming1": {"D": "Id", "F": "Value"},
    },

    "滑动鞍座": {
        "fixed": {
            5: "BⅠ",
            6: "固定端",
            7: "右",
            12: "120"
        },
        "mapping": {
            8: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体圆筒", "Name": "圆筒公称直径"},
            9: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体圆筒", "Name": "是否按外径计算"},
            10: {"table": "产品设计活动表_元件计算结果表", "元件名称": "壳体圆筒", "Name": "圆筒名义厚度"},

            13: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "鞍式支座高度h"},
            14: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "底板长度"},
            15: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "底板宽度"},
            16: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "底板厚度"},
            17: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "腹板厚度"},

            35: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "筋板长度"},
            36: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "筋板宽度"},
            37: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "筋板顶部宽度"},
            38: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "筋板厚度"},
            39: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "垫板厚度"},
            40: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "垫板弧长"},
            41: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "垫板宽度"},
            42: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "腹板至垫板边缘距离"},

            48: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "螺纹规格"},
            49: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "螺孔直径"},
            50: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "螺孔长度"},
            51: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "螺栓孔间距1"},
            52: {"table": "产品设计活动表_元件计算结果表", "元件名称": "鞍座", "Name": "螺栓孔间距2"},
        },
        "aiming1": {"D": "Id", "F": "Value"},
    }
}
def _unique_sheet_title(wb, base):
    if base not in wb.sheetnames:
        return base
    i = 1
    while True:
        name = f"{base}_{i}"
        if name not in wb.sheetnames:
            return name
        i += 1
import pymysql
from openpyxl import load_workbook

def _unique_sheet_title(wb, base):
    """生成唯一的 sheet 名称"""
    if base not in wb.sheetnames:
        return base
    i = 1
    while True:
        name = f"{base}_{i}"
        if name not in wb.sheetnames:
            return name
        i += 1

def fill_jieguan_falan_sheets(wb, product_id, conn, keep_template=False):
    if "接管法兰" not in wb.sheetnames:
        return

    template_ws = wb["接管法兰"]

    # 管口字段 -> 模板行号映射，F列固定
    kou_row_map = {
        "管口代号": 13,
        "管口功能": 14,
        "公称尺寸": 15,
        "法兰标准": 16,
        "压力等级": 17,
        "法兰型式": 18,
        "密封面型式": 19,
        "轴向定位距离": 20,
        "周向方位（°）": 21
    }

    # 元件计算结果表映射: row_idx -> (字段名, 元件名称, 列号)
    mapping_rules = {
        5: ("椭圆形封头计算内径", "封头"),
        6: ("圆筒内径", "圆筒"),
        7: ("圆筒名义厚度", "圆筒"),
        8: ("圆筒名义厚度", "圆筒"),
        36: ("接管中心线与法线夹角(包括封头)", "jieguan"),
        38: ("接管实际外伸长度", "jieguan"),
        39: ("接管实际内伸长度", "jieguan"),
        41: ("开孔方位", "jieguan"),
        42: ("接管中心线至筒体轴线距离(偏心距)", "jieguan"),
    }

    with conn.cursor(pymysql.cursors.DictCursor) as cursor:
        cursor.execute("""
            SELECT 管口代号, 管口功能, 公称尺寸, 法兰标准, 压力等级, 法兰型式, 密封面型式,
                   轴向定位距离, `周向方位（°）`
            FROM 产品设计活动表_管口表
            WHERE 产品ID=%s
            ORDER BY 管口代号
        """, (product_id,))
        kou_rows = cursor.fetchall()

        for kou in kou_rows:
            base_title = f"{kou.get('管口功能', '接管')}_接管法兰"
            new_title = _unique_sheet_title(wb, base_title)
            new_ws = wb.copy_worksheet(template_ws)
            new_ws.title = new_title

            # --- 填管口字段到固定行F列 ---
            for field, row in kou_row_map.items():
                if field in kou:
                    new_ws.cell(row=row, column=6).value = kou[field]  # F列固定

            # --- 填元件计算结果表 ---
            for row_idx, (field_name, source) in mapping_rules.items():
                if source == "jieguan":
                    comp_name = (kou.get("管口功能") or "").strip() + "接管"
                    cursor.execute("""
                        SELECT Value FROM 产品设计活动表_元件计算结果表
                        WHERE 产品ID=%s AND 元件名称=%s AND Name=%s
                        LIMIT 1
                    """, (product_id, comp_name, field_name))
                    r = cursor.fetchone()
                    if r:
                        new_ws.cell(row=row_idx, column=6).value = r.get("Value")
                else:
                    cursor.execute("""
                        SELECT Id, Value FROM 产品设计活动表_元件计算结果表
                        WHERE 产品ID=%s AND 元件名称=%s AND Name=%s
                        LIMIT 1
                    """, (product_id, source, field_name))
                    r = cursor.fetchone()
                    if r:
                        new_ws.cell(row=row_idx, column=6).value = r.get("Value")

    if not keep_template:
        wb.remove(template_ws)

def fetch_value(conn, table, product_id, filter_dict, value_col="Value"):
    """
    从数据库中根据条件取值。
    filter_dict: 表示查询条件，比如 {"元件名称":"管箱封头","Name":"封头类型代号"}
    value_col: 取值列，默认为 Value
    """
    where_clause = " AND ".join(f"`{k}`='{v}'" for k, v in filter_dict.items())
    sql = f"SELECT `{value_col}` FROM `{table}` WHERE `产品ID`='{product_id}' AND {where_clause} LIMIT 1"
    with conn.cursor() as cursor:
        cursor.execute(sql)
        result = cursor.fetchone()
        return result[0] if result else None


def fill_all_components(product_id, template_path, output_path, conn):
    wb = load_workbook(template_path)

    for sheet_name, sheet_rules in SHEET_RULES.items():
        if sheet_name not in wb.sheetnames:
            continue
        ws = wb[sheet_name]

        # 先写固定值
        for row, val in sheet_rules.get("fixed", {}).items():
            ws.cell(row=row, column=6, value=val)  # 默认填F列，可根据规则调整

        # 处理mapping
        for row, rule in sheet_rules.get("mapping", {}).items():
            table = rule.get("table")
            if not table:
                continue
            # 提取查询条件
            filter_dict = {k: v for k, v in rule.items() if k not in ["table"]}

            # 判断是aiming1还是aiming2
            aiming = sheet_rules.get("aiming1") if table == "产品设计活动表_元件计算结果表" else sheet_rules.get(
                "aiming2")
            value_col = aiming.get("F") if aiming else "Value"

            val = fetch_value(conn, table, product_id, filter_dict, value_col=value_col)
            if val is not None:
                ws.cell(row=row, column=6, value=val)  # 默认填F列，可扩展
    fill_jieguan_falan_sheets(wb, product_id, conn)

    # 保存新文件
    wb.save(output_path)


